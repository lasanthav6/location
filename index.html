<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arrival Counter + Firebase Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --accent:#22c55e; --danger:#ef4444; --blue:#3b82f6; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    header { padding:16px; text-align:center; border-bottom:1px solid #1f2937; }
    main { max-width:900px; margin:20px auto; padding:0 16px; display:grid; gap:16px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    button, select, input { background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:8px; padding:12px; font-size:16px; }
    button.primary { background:var(--accent); color:#000; font-weight:bold; }
    button.active { background:var(--blue); }
    .counter-card { text-align:center; padding:40px 20px; background:linear-gradient(135deg,#1e293b,#111827); border-radius:16px; }
    #arrivalCount { font-size:100px; font-weight:900; background:linear-gradient(45deg,#22c55e,#34d399); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .place-container { background:#1e293b; padding:20px; border-radius:12px; text-align:center; }
    .place-btns { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }
    .place-btn { min-width:60px; padding:12px 20px; }
    #placeDisplay { font-size:48px; font-weight:bold; margin:16px 0; color:var(--accent); }
    .type-btns { display:flex; gap:20px; justify-content:center; margin-top:20px; }
    .type-btn { width:120px; padding:16px; font-size:18px; font-weight:bold; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:999; }
    .modal { background:#111827; border-radius:16px; padding:40px; text-align:center; max-width:90%; }
    .modal h2 { font-size:36px; margin:0 0 16px; }
    .show { display:flex; }
    @media (max-width:640px) { #arrivalCount { font-size:70px; } #placeDisplay { font-size:36px; } }
  </style>
</head>
<body>

  <header>
    <h1>Arrival Counter + Logger</h1>
    <div class="status" id="status">Initializing Firebase...</div>
  </header>

  <main>

    <!-- BIG COUNTER -->
    <section class="card counter-card">
      <h2>Arrival Count</h2>
      <div id="arrivalCount">0</div>
      <div class="row">
        <button class="secondary" id="decrement">-</button>
        <button class="primary" id="increment">+</button>
      </div>
    </section>

    <!-- PLACE SELECTOR -->
    <section class="card place-container">
      <h3>Select Place</h3>
      <div class="place-btns">
        <button class="place-btn" data-place="A">A</button>
        <button class="place-btn" data-place="B">B</button>
        <button class="place-btn" data-place="C">C</button>
        <button class="place-btn" data-place="E">E</button>
      </div>
      <select id="numberSelect"></select>
      <div id="placeDisplay">--</div>

      <div class="type-btns">
        <button class="type-btn secondary" id="keifun">KEIFUN</button>
        <button class="type-btn secondary" id="ooga">OOGA</button>
      </div>
    </section>

    <!-- TARGET SETTINGS -->
    <section class="card">
      <h3>Target Location</h3>
      <div class="row">
        <input id="lat" type="number" step="0.000001" placeholder="Latitude">
        <input id="lng" type="number" step="0.000001" placeholder="Longitude">
        <input id="radius" type="number" value="100" style="width:100px;">
        <button class="secondary" id="useCurrent">Current</button>
        <button class="primary" id="setTarget">Set</button>
      </div>
      <p id="targetStatus">No target set</p>
    </section>

    <!-- LIVE LOCATION -->
    <section class="card">
      <h3>Live Location</h3>
      <div class="row">
        <div>Lat: <span id="curLat">--</span></div>
        <div>Lng: <span id="curLng">--</span></div>
        <div>Acc: <span id="curAcc">--</span></div>
      </div>
      <p>Distance: <span id="distance">--</span> | Status: <span id="arrivalBadge" class="badge warn">Not arrived</span></p>
    </section>

  </main>

  <!-- ARRIVAL POPUP + BEEP -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>ARRIVED!</h2>
      <p id="modalPlace">Place: --</p>
      <p id="modalType">Type: --</p>
    </div>
  </div>

  <!-- Firebase + NoSleep -->
  <script src="https://cdn.jsdelivr.net/npm/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Prevent screen sleep
    const noSleep = new NoSleep();
    document.addEventListener('click', () => { noSleep.enable(); }, { once: true });

    // Firebase Config (ඔයාගේ project එක)
    const firebaseConfig = {
      apiKey: "AIzaSyCU0m583I4iMI5hOAwX33PF-Em9Av4Nz4Y",
      authDomain: "signal-b293d.firebaseapp.com",
      databaseURL: "https://signal-b293d-default-rtdb.firebaseio.com",
      projectId: "signal-b293d",
      storageBucket: "signal-b293d.firebasestorage.app",
      messagingSenderId: "163860681610",
      appId: "1:163860681610:web:5515a5ba0fdbac6122ee73",
      measurementId: "G-0KX3MZ0RG4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // State
    let target = null;
    let arrived = false;
    let watchId = null;
    let currentPlace = null;  // e.g. "A7"
    let currentType = null;  // "KEIFUN" or "OOGA"
    let arrivalCount = parseInt(localStorage.getItem('arrivalCount') || '0');

    const el = id => document.getElementById(id);
    el('arrivalCount').textContent = arrivalCount;

    // Beep sound
    const beep = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // short beep
    function playBeep() {
      beep.currentTime = 0;
      beep.play();
      setTimeout(() => beep.play(), 300);
      setTimeout(() => beep.play(), 600);
    }

    // Update place display & dropdown
    function updatePlace(letter) {
      const ranges = { A:12, B:8, C:3, E:6 };
      const select = el('numberSelect');
      select.innerHTML = '';
      for (let i = 1; i <= ranges[letter]; i++) {
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = i;
        select.add(opt);
      }
      select.onchange = () => {
        currentPlace = letter + select.value;
        el('placeDisplay').textContent = currentPlace;
        // Reset type buttons when new place selected
        el('keifun').classList.remove('active');
        el('ooga').classList.remove('active');
        currentType = null;
      };
      select.value = 1;
      currentPlace = letter + '1';
      el('placeDisplay').textContent = currentPlace;
    }

    // Type buttons
    el('keifun').onclick = () => { currentType = 'KEIFUN'; updateTypeButtons(); };
    el('ooga').onclick = () => { currentType = 'OOGA'; updateTypeButtons(); };
    function updateTypeButtons() {
      el('keifun').classList.toggle('active', currentType === 'KEIFUN');
      el('ooga').classList.toggle('active', currentType === 'OOGA');
    }

    // Save to Firebase
    function logArrival() {
      if (!currentPlace || !currentType) return;
      const data = {
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString('en-CA'),
        time: new Date().toLocaleTimeString(),
        place: currentPlace,
        type: currentType,
        count: arrivalCount
      };
      db.ref('arrivals').push(data);
      console.log('Saved to Firebase:', data);
    }

    // Haversine
    function distanceMeters(a, b) {
      const toRad = v => v * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLon = toRad(b.lng - a.lng);
      const x = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
      return R * c;
    }

    // Location updates
    function onPosition(pos) {
      const c = pos.coords;
      el('curLat').textContent = c.latitude.toFixed(6);
      el('curLng').textContent = c.longitude.toFixed(6);
      el('curAcc').textContent = Math.round(c.accuracy) + 'm';

      if (!target) return;
      const dist = distanceMeters({lat: c.latitude, lng: c.longitude}, target);
      el('distance').textContent = Math.round(dist) + 'm';

      const inside = dist <= target.radius;

      if (inside && !arrived) {
        arrived = true;
        arrivalCount++;
        localStorage.setItem('arrivalCount', arrivalCount);
        el('arrivalCount').textContent = arrivalCount;
        el('arrivalBadge').textContent = 'ARRIVED';
        el('arrivalBadge').classList.replace('warn','ok');

        playBeep();
        el('modalPlace').textContent = 'Place: ' + (currentPlace || '--');
        el('modalType').textContent = 'Type: ' + (currentType || '--');
        el('modalBackdrop').classList.add('show');

        logArrival(); // Save to Firebase

      } else if (!inside && arrived) {
        arrived = false;
        el('arrivalBadge').textContent = 'Not arrived';
        el('arrivalBadge').classList.replace('ok','warn');
        el('modalBackdrop').classList.remove('show'); // Auto close popup
      }
    }

    // Setup
    document.querySelectorAll('.place-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.place-btn').forEach(b => b.classList.remove('primary'));
        btn.classList.add('primary');
        updatePlace(btn.dataset.place);
      };
    });

    el('setTarget').onclick = () => {
      const lat = parseFloat(el('lat').value);
      const lng = parseFloat(el('lng').value);
      const rad = parseFloat(el('radius').value) || 100;
      if (isNaN(lat) || isNaN(lng)) return alert('Invalid coordinates');
      target = { lat, lng, radius: rad };
      el('targetStatus').textContent = `Target: ${lat.toFixed(6)}, ${lng.toFixed(6)} ±${rad}m`;
    };

    el('useCurrent').onclick = () => {
      navigator.geolocation.getCurrentPosition(p => {
        el('lat').value = p.coords.latitude.toFixed(6);
        el('lng').value = p.coords.longitude.toFixed(6);
        el('setTarget').click();
      });
    };

    el('increment').onclick = () => { arrivalCount++; localStorage.setItem('arrivalCount', arrivalCount); el('arrivalCount').textContent = arrivalCount; };
    el('decrement').onclick = () => { if (arrivalCount > 0) { arrivalCount--; localStorage.setItem('arrivalCount', arrivalCount); el('arrivalCount').textContent = arrivalCount; }};

    // Start tracking
    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(onPosition, err => {
        el('status').textContent = 'Location error: ' + err.message;
      }, { enableHighAccuracy: true, maximumAge: 2000, timeout: 15000 });
      el('status').textContent = 'Tracking active | Screen stays ON | Firebase connected';
    }

    // Default place A
    document.querySelector('[data-place="A"]').click();
  </script>
</body>
</html>
